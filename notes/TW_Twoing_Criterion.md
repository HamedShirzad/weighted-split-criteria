# Twoing Criterion (TW)

## اطلاعات کلی
- **منبع اصلی:** Classification and Regression Trees (CART) - Breiman et al.
- **سال معرفی:** 1984
- **نویسندگان:** Leo Breiman, Jerome Friedman, Richard Olshen, Charles Stone
- **انگیزه:** متعادل کردن تقسیم کلاس‌ها و حفظ توازن حجم شاخه‌های درخت
- **مزیت کلیدی:** ترکیب تفکیک کلاس‌ها با تعادل ساختاری درخت

## هدف و کاربرد

معیار Twoing به‌جای اندازه‌گیری مستقیم impurity هر گره، بر دو هدف اصلی تمرکز دارد:

1. **بیشینه‌کردن تفکیک کلاس‌ها** بین شاخه‌های چپ و راست
2. **متعادل نگه‌داشتن اندازه شاخه‌ها** برای جلوگیری از درخت‌های نامتوازن

این معیار مخصوصاً برای **مسائل چندکلاسه** طراحی شده و تمایل دارد کلاس‌های مشابه را در یک طرف تجمیع کند.

## فرمول ریاضی

### فرمول اصلی
$$T = \frac{p_L \cdot p_R}{4}\left(\sum_{j \in C}\left|p_{Lj} - p_{Rj}\right|\right)^2$$

### تعریف متغیرها

| نماد | تعریف |
|------|--------|
| **$T$** | امتیاز معیار Twoing |
| **$p_L$** | نسبت نمونه‌هایی که به شاخه چپ می‌روند |
| **$p_R$** | نسبت نمونه‌هایی که به شاخه راست می‌روند |
| **$C$** | مجموعه تمام کلاس‌های موجود |
| **$p_{Lj}$** | احتمال تعلق یک نمونه از شاخه چپ به کلاس $j$ |
| **$p_{Rj}$** | احتمال تعلق یک نمونه از شاخه راست به کلاس $j$ |

### محاسبات تکمیلی

**نسبت‌های شاخه‌ها:**
$$p_L = \frac{n_L}{n_{total}}, \quad p_R = \frac{n_R}{n_{total}}$$

**احتمالات کلاس در هر شاخه:**
$$p_{Lj} = \frac{n_{Lj}}{n_L}, \quad p_{Rj} = \frac{n_{Rj}}{n_R}$$

## مثال محاسبه

فرض کنید در یک گره 40 نمونه از سه کلاس A, B, C داریم:

| شاخه | A | B | C | مجموع |
|------|---|---|---|-------|
| چپ  | 10| 2 | 8 | 20    |
| راست| 5 | 9 | 6 | 20    |

### گام‌های محاسبه:

**گام 1:** محاسبه نسبت‌های شاخه
- $p_L = p_R = 0.5$

**گام 2:** محاسبه توزیع کلاس‌ها
- شاخه چپ: $(0.5, 0.1, 0.4)$
- شاخه راست: $(0.25, 0.45, 0.3)$

**گام 3:** محاسبه مجموع قدرمطلق تفاضل‌ها
$$\sum_{j}|p_{Lj}-p_{Rj}| = |0.5-0.25| + |0.1-0.45| + |0.4-0.3| = 0.25 + 0.35 + 0.1 = 0.70$$

**گام 4:** محاسبه نهایی
$$T = \frac{0.5 \times 0.5}{4} \times (0.7)^2 = 0.25 \times 0.49 = 0.1225$$

## ویژگی‌های فنی

- **پیچیدگی محاسباتی:** $O(n \cdot k)$ جایی که $n$ تعداد نمونه‌ها و $k$ تعداد کلاس‌هاست
- **محدوده مقادیر:** $0 \leq T \leq 0.5$
- **حساسیت به نامتعادلی:** متوسط - تمایل به ایجاد شاخه‌های متعادل
- **مناسب برای:** مسائل چندکلاسه با کلاس‌های متعدد

### تفسیر مقادیر:
- **$T = 0$**: تقسیم بی‌اثر (توزیع کلاس‌ها در دو شاخه یکسان)
- **$T = 0.5$**: تقسیم ایده‌آل (جدایی کامل کلاس‌ها با شاخه‌های متعادل)

## مقایسه با سایر معیارها

| جنبه | Twoing | Gini | Entropy |
|------|--------|------|---------|
| **نوع معیار** | تفکیک دوتایی + توازن حجم | ناخالصی گره | میزان بی‌نظمی |
| **حساسیت به چندکلاسه** | بالا | متوسط | متوسط |
| **توازن شاخه‌ها** | تشویق می‌کند | بی‌تفاوت | بی‌تفاوت |
| **پیچیدگی محاسبه** | بالاتر | پایین | متوسط |
| **عملکرد در داده نامتوازن** | متعادل‌تر | ممکن است نامتوازن باشد | متوسط |

## مزایا

### 1. شاخه‌های متعادل
- ضریب $\frac{p_L \cdot p_R}{4}$ تمایل به نگه‌داشتن دو شاخه در اندازه‌های مشابه دارد
- کمک به ساخت درخت‌های قابل تفسیر و کم‌عمق

### 2. درک شباهت کلاس‌ها
- کلاس‌های با توزیع مشابه را در بالای درخت در یک طرف نگه می‌دارد
- کلاس‌های متمایز را در سطوح پایین‌تر جدا می‌کند

### 3. عملکرد رقابتی
- در مسائل چندکلاسه اغلب عملکرد مشابه یا بهتر از Gini دارد
- عمق درخت کمتری نسبت به سایر معیارها تولید می‌کند

## محدودیت‌ها

### 1. پیچیدگی محاسباتی
- محاسبه مجموع قدرمطلق برای همه کلاس‌ها زمان‌بر است
- در داده‌های چندکلاسه بزرگ کارایی کمتری دارد

### 2. کارایی مشابه در مسائل باینری
- وقتی فقط دو کلاس وجود دارد، تفاوت چندانی با Gini ندارد
- مزیت اصلی در مسائل چندکلاسه آشکار می‌شود

### 3. حساسیت به نویز
- اگر کلاس‌های نادر در دو شاخه پخش شوند، ممکن است تقسیم مطلوب نادیده گرفته شود

## نکات پیاده‌سازی

### مراقبت‌های ضروری:
- **تقسیم بر صفر:** اگر $n_L = 0$ یا $n_R = 0$، مقدار $T = 0$ برگردانید
- **شاخه‌های خالی:** بررسی کنید که هر شاخه حداقل یک نمونه داشته باشد
- **دقت عددی:** از overflow در محاسبه مجذور جلوگیری کنید

### بهینه‌سازی:
- کش کردن محاسبات تکراری
- پیش‌محاسبه توزیع کلاس‌ها
- استفاده از روش‌های سریع برای محاسبه قدرمطلق

## کد شبه

```python

def twoing_criterion(y_left, y_right):
"""

 محاسبه امتیاز معیار
 Twoing
  برای تقسیم داده‌ها
    
    Parameters:
    y_left: آرایه برچسب‌های کلاس برای شاخه چپ
    y_right: آرایه برچسب‌های کلاس برای شاخه راست
    
    Returns:
    T: امتیاز معیار Twoing (بین 0 و 0.5)
    """
    
    # محاسبه تعداد نمونه‌ها
    n_left = len(y_left)
    n_right = len(y_right)
    n_total = n_left + n_right
    
    # بررسی شرایط خاص
    if n_left == 0 or n_right == 0:
        return 0.0
    
    # محاسبه نسبت‌های شاخه‌ها
    p_L = n_left / n_total
    p_R = n_right / n_total
    
    # یافتن کلاس‌ها و محاسبه تفاضل‌ها
    classes = unique(concatenate([y_left, y_right]))
    diff_sum = 0.0
    
    for class_j in classes:
        p_Lj = sum(y_left == class_j) / n_left
        p_Rj = sum(y_right == class_j) / n_right
        diff_sum += abs(p_Lj - p_Rj)
    
    # فرمول نهایی Twoing
    return (p_L * p_R / 4.0) * (diff_sum ** 2)



## منابع
- Breiman, L., Friedman, J., Olshen, R., & Stone, C. (1984). Classification and Regression Trees. Chapman & Hall/CRC
- مقالات مقایسه‌ای معیارهای تقسیم در درخت‌های تصمیم
- مستندات الگوریتم CART و پیاده‌سازی‌های مدرن
